<div class="form-container animate-fade-in">
  <h2 class="form-title">Submit Evaluation Form</h2>

  <!-- Ghost Detection Overlay -->
  <div *ngIf="isGhostChecking" class="ghost-detection-overlay">
    <div class="ghost-detection-modal">
      <div class="ghost-detection-header">
        <div class="ghost-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h3 class="ghost-title">Security Verification</h3>
        <p class="ghost-subtitle">Verifying personnel authenticity before submission</p>
      </div>

      <div class="ghost-progress-container">
        <div class="ghost-progress-bar">
          <div class="ghost-progress-fill" [style.width.%]="ghostCheckProgress"></div>
        </div>
        <div class="ghost-progress-text">{{ ghostCheckProgress | number:'1.0-0' }}% Complete</div>
      </div>

      <div class="ghost-steps-container">
        <div
          *ngFor="let step of ghostCheckSteps; let i = index"
          class="ghost-step"
          [class.active]="i === currentGhostStep"
          [class.completed]="i < currentGhostStep"
        >
          <div class="step-icon">
            <i *ngIf="i < currentGhostStep" class="fas fa-check"></i>
            <i *ngIf="i === currentGhostStep" class="fas fa-spinner fa-spin"></i>
            <i *ngIf="i > currentGhostStep" class="fas fa-circle"></i>
          </div>
          <div class="step-content">
            <div class="step-text">{{ step }}</div>
            <div *ngIf="i === currentGhostStep" class="step-status">Processing...</div>
            <div *ngIf="i < currentGhostStep" class="step-status completed">Completed</div>
          </div>
        </div>
      </div>

      <div class="ghost-message">
        <i class="fas fa-info-circle"></i>
        {{ ghostCheckMessage }}
      </div>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-grid">
    <!-- PDF Selection -->
    <div>
      <label for="pdfId">Select Signed PDF *</label>
      <select id="pdfId" formControlName="pdfId" class="select-input" required (change)="onPdfChange($event)">
        <option value="">Select a signed document</option>
        <option *ngFor="let pdf of signedPdfs" [value]="pdf.id">{{ pdf.file_name }}</option>
      </select>
      <div *ngIf="form.get('pdfId')?.invalid && form.get('pdfId')?.touched" class="error-message">
        Please select a PDF document.
      </div>
    </div>

    <!-- Mark as Signed (if PDF selected) -->
    <div *ngIf="selectedPdf" class="mt-2">
      <label class="flex items-center gap-2">
        <input
          type="checkbox"
          [(ngModel)]="selectedPdf.mark_as_signed"
          [ngModelOptions]="{standalone: true}"
          name="mark_as_signed"
        />
        Mark this file as signed (no signature image)
      </label>
    </div>

    <!-- Form Type -->
    <div>
      <label for="form_type">Form Type *</label>
      <select id="form_type" formControlName="form_type" class="select-input" required>
        <option value="">Select type</option>
        <option *ngFor="let type of formTypes" [value]="type">{{ type }}</option>
      </select>
      <div *ngIf="form.get('form_type')?.invalid && form.get('form_type')?.touched" class="error-message">
        Please select a form type.
      </div>
    </div>

    <!-- Priority -->
    <div>
      <label for="priority">Priority *</label>
      <select id="priority" formControlName="priority" class="select-input" required>
        <option value="">Select priority</option>
        <option *ngFor="let level of priorities" [value]="level">{{ level | titlecase }}</option>
      </select>
      <div *ngIf="form.get('priority')?.invalid && form.get('priority')?.touched" class="error-message">
        Please select a priority level.
      </div>
    </div>

    <!-- Receiver Dropdown -->
    <div>
      <label for="receiver_id">Send To *</label>
      <select id="receiver_id" formControlName="receiver_id" class="select-input" required>
        <option value="">Select recipient</option>
        <option *ngIf="supervisor" [value]="supervisor.user">
          Supervisor - {{ supervisor.full_name }}
        </option>
        <option *ngIf="admin" [value]="admin.user">
          Admin - {{ admin.full_name }}
        </option>
      </select>
      <div *ngIf="form.get('receiver_id')?.invalid && form.get('receiver_id')?.touched" class="error-message">
        Please select a recipient.
      </div>
    </div>

    <!-- Submit Button -->
    <div class="pt-2">
      <button type="submit" [disabled]="isSubmitting || isGhostChecking || form.invalid" class="submit-btn">
        <span *ngIf="!isSubmitting && !isGhostChecking">Submit Evaluation Form</span>
        <span *ngIf="isSubmitting">Submitting...</span>
        <span *ngIf="isGhostChecking">Security Check in Progress...</span>
      </button>
    </div>

    <!-- Upload Progress Bar -->
    <div *ngIf="progress > 0 && progress < 100" class="progress-container mt-2">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progress"></div>
      </div>
      <div class="text-sm text-gray-500 mt-1">Upload Progress: {{ progress }}%</div>
    </div>

    <!-- Final Message -->
    <div *ngIf="message" [class]="message.includes('success') || message.includes('Success') ? 'text-green-600' : 'text-red-600'" class="mt-2">
      {{ message }}
    </div>
  </form>
</div>
